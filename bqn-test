#!/usr/bin/env bqn

âŸ¨Green, Yellow, RedâŸ© â‡ â€¢Import "../bqn-color/color.bqn"
s â‡ â€¢Import "../bqn-code/lib/string.bqn"

nl â† @+10

title â† {
    c â† Greenâ€¿Yellowâ€¿Red # colors
    d â† "Â·âˆ˜â—‹"            # dots
    nlâˆ¾(âˆ¾c{ğ•ğ•©}Â¨d)âˆ¾Green " bqn-test "âˆ¾(âˆ¾c{ğ•ğ•©}Â¨â—‹âŒ½d)âˆ¾nl
}

ListRecursiveFiles â† {
    l â† â€¢file.List ğ•©             # files/directories
    P â† (ğ•©âˆ¾"/")âŠ¸âˆ¾                # prefix
    m â† 'd'=â€¢file.TypeÂ¨PÂ¨l       # mask
    d â† l/Ëœm                     # directories
    f â† l/Ëœ((âˆ¨Â´1â†“".bqn"âŠ¸â·)Â¨l)âˆ§Â¬m # file
    (PÂ¨f) âˆ¾ âˆ¾ğ•ŠÂ¨PÂ¨d
}

TestSingleFile â† {
    l â† â€¢file.Lines ğ•©                         # lines
    t â† "UnitTest"                            # target
    r â† "UnitTestActual"                      # replace
    m â† s.Unlines tâ€¿râŠ¸s.ReplaceÂ¨l             # modded file
    u â† {s.Unwords 1â†“s.Wordsğ•©}Â¨l/Ëœ{âŠ‘0âˆ¾Ëœtâ·ğ•©}Â¨l # unit tests
    o â† "_temp"
    o â€¢file.Chars ""
    â€¢BQN m
    f   â† ğ•¨âŠ""â€¿(ğ•©âˆ¾" summary: ") # file name
    res â† 'x'=â€¢file.Chars o     # results
    ft  â† (nlâŠ¸âˆ¾Â¨u)/ËœÂ¬res        # failing tests
    â€¢file.Remove o
    âˆ¾fâˆ¾âˆ¾(resâŠâŸ¨Red "â—‹",Green "âˆ˜"âŸ©)âˆ¾(RedÂ¨ft)âˆ¾((Â¬ğ•¨)âˆ§Ã—â‰ ft)âŠ""â€¿nl
}

IncludesUnitTest â† { âˆ¨Â´(âˆ¨Â´"UnitTest"âŠ¸â·)Â¨(Â¬Â·âˆ¨Â´"â‡"âŠ¸â·)Â¨âŠ¸/â€¢file.Linesğ•© }

main â† {
    â€¢Out title
    (Red "Must provide directory (`pwd` for current)") ! 0â‰ â‰ â€¢args
    d â† 0âŠ‘â€¢args  # directory
    v â† 1<â‰ â€¢args # verbose
    { v ? (Red "2nd argument must be '-v' (if specified)") ! "-v"â‰¡âŠ‘1âŠâ€¢args ; âˆ }
    out â† vâŠ¸TestSingleFileÂ¨âˆ§IncludesUnitTestÂ¨âŠ¸/ListRecursiveFiles d
    { v ? â€¢OutÂ¨ out ; â€¢Out âˆ¾out }
    â€¢Out âŸ¨âŸ©
}

main
