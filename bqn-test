#!/usr/bin/env bqn

c  â‡ â€¢Import "../bqn-color/color.bqn"
s  â‡ â€¢Import "../bqn-code/lib/string.bqn"
fs â‡ â€¢Import "../bqn-code/lib/file_system.bqn"

# Constants
nl     â† @+10 # new line
colors â† c.Greenâ€¿c.Yellowâ€¿c.Red
dots   â† "âˆ˜â—‹âŒ¾"
cdots  â† colors{ğ•ğ•©}Â¨dots# colored dots
title  â† nlâˆ¾(âˆ¾cdots)âˆ¾c.Green " bqn-test "âˆ¾(âˆ¾colors{ğ•ğ•©}Â¨â—‹âŒ½dots)âˆ¾nl

TestSingleFile â† {
    l   â† â€¢file.Lines ğ•©                 # lines
    t   â† "UnitTest"                    # target
    r   â† "UnitTestActual"              # replace
    r2  â† "ExecuteHalf"                 # replace 2
    m   â† {âŠ‘0âˆ¾Ëœ"Unit"â·ğ•©}Â¨l              # mask for unit tests
    Ts  â† (Â¬Â·âˆ¨`'â‰¡'âŠ¸=)âŠ¸/Â¨âŒ¾(mâŠ¸/)          # trim suffix
    mf  â† s.Unlines    tâ€¿r âŠ¸s.ReplaceÂ¨l # modded file
    mf2 â† s.Unlines Ts tâ€¿r2âŠ¸s.ReplaceÂ¨l # modded file 2
    Op  â† {s.Unwords Â¯1â†“"â‰¡" s.Split tâ€¿r2 s.Replace ğ•©}
    u   â† {s.Unwords 1â†“s.Wordsğ•©}Â¨l/Ëœm # unit tests
    o   â† "_temp"
    o â€¢file.Chars ""
    â€¢BQN mf
    f   â† ğ•¨âŠ""â€¿(ğ•©âˆ¾" summary: ") # file name
    uts â† ".fx"âŠâ€¢file.Chars o   # unit test status (pass/(x)/fail)
    â€¢file.Chars o
    ft  â† (nlâŠ¸âˆ¾Â¨u)/Ëœ2=uts # failing tests
    o â€¢file.Chars ""
    â€¢BQN mf2
    ce â† 1â†“â€¢file.Lines o # current evaluations
    fe â† ce/Ëœ(â‰ ce)â†‘Ã—uts  # failing evauations (only) # TODO look at the â‰ res2â†‘
    â€¢file.Remove o
    âˆ¾fâˆ¾âˆ¾(utsâŠcdots)âˆ¾((c.RedÂ¨ft)â‹ˆÂ¨(" currently: "âŠ¸âˆ¾âˆ˜c.YellowÂ¨fe))âˆ¾((Â¬ğ•¨)âˆ§Ã—â‰ ft)âŠ""â€¿nl
}

IncludesUnitTest â† { âˆ¨Â´(âˆ¨Â´1â†‘"UnitFail"âŠ¸â·âˆ¨"UnitTest"âŠ¸â·)Â¨(Â¬Â·âˆ¨Â´"â‡"âŠ¸â·)Â¨âŠ¸/â€¢file.Linesğ•© }

main â† {
    â€¢Out title
    (c.Red "Must provide directory (`pwd` for current)") ! 0â‰ â‰ â€¢args
    d â† 0âŠ‘â€¢args  # directory
    v â† 1<â‰ â€¢args # verbose
    { v ? (c.Red "2nd argument must be '-v' (if specified)") ! "-v"â‰¡âŠ‘1âŠâ€¢args ; âˆ }
    out â† vâŠ¸TestSingleFileÂ¨âˆ§IncludesUnitTestÂ¨âŠ¸/fs.ListRecursiveBQNFiles d
    { v ? â€¢OutÂ¨ out ; â€¢Out âˆ¾out }
    t â† â€¢FmtÂ¨ âŠ‘+Ë(+Â´Ë˜dotsâŠ¸(=âŒœ))Â¨ out # totals
    â€¢Out nlâˆ¾nlâˆ¾Ëœ", " s.Join colors{ğ•ğ•©}Â¨tâˆ¾Â¨" passed"â€¿" xfailed"â€¿" failed"
}

main
