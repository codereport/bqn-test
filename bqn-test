#!/usr/bin/env bqn

c  â‡ â€¢Import "deps/color.bqn"
s  â‡ â€¢Import "deps/string.bqn"
fs â‡ â€¢Import "deps/file_system.bqn"

# Constants
nl     â† @+10 # new line
colors â† c.Greenâ€¿c.Yellowâ€¿c.Red
dots   â† "âˆ˜â—‹âŒ¾"
cdots  â† colors{ğ•ğ•©}Â¨dots # colored dots
title  â† nlâˆ¾(âˆ¾cdots)âˆ¾c.Green " bqn-test "âˆ¾(âˆ¾colors{ğ•ğ•©}Â¨â—‹âŒ½dots)âˆ¾nl
o      â† â€¢wdpathâˆ¾"/_temp" # temporary output file

TestSingleFile â† {
    l   â† â€¢file.Lines ğ•©                       # lines
    t   â† "UnitTest"                          # target
    r   â† "UnitTestActual"                    # replace
    r2  â† "ExecuteHalf"                       # replace 2
    m   â† {(âŠ‘0âˆ¾Ëœ"u.Unit"â·ğ•©)âˆ¨(âŠ‘0âˆ¾Ëœ"Unit"â·ğ•©)}Â¨l # mask for unit tests # TODO cleanup
    Ts  â† (Â¬Â·âˆ¨`'â‰¡'âŠ¸=)âŠ¸/Â¨âŒ¾(mâŠ¸/)                # trim suffix
    mf  â† s.Unlines    tâ€¿r âŠ¸s.ReplaceÂ¨l       # modded file
    mf2 â† s.Unlines Ts tâ€¿r2âŠ¸s.ReplaceÂ¨l       # modded file 2
    u   â† {s.Unwords 1â†“s.Wordsğ•©}Â¨l/Ëœm         # unit tests
    p   â† â‹ˆ'/'s.Join Â¯1â†“'/'s.Split2ğ•©          # path for script

    fs.Touch o â‹„ p â€¢BQN mf
    f   â† ğ•¨âŠ""â€¿(ğ•©âˆ¾" summary: ") # file name
    uts â† ".fx"âŠâ€¢file.Chars o   # unit test status (pass/(x)/fail)
    ft  â† (nlâŠ¸âˆ¾Â¨u)/Ëœ2=uts       # failing tests

    fs.Clear o â‹„ p â€¢BQN mf2
    ce â† { Ã—â‰ ft ? s.Lines2 2â†“â€¢file.Chars o ; âŸ¨âŸ© } # current evaluations
    fe â† ce((â‰ âŠ¸â†‘âŸœÃ—)/âŠ£)uts                         # failing evauations (only)
    â€¢file.Remove o

    Nnl â† {1<â‰ s.Lines ğ•©} # need new line
    âˆ¾fâˆ¾âˆ¾(utsâŠcdots)âˆ¾((c.RedÂ¨ft)â‹ˆÂ¨(" currently: "âŠ¸âˆ¾âˆ˜(c.Yellow Nnlâ—¶âŸ¨âŠ¢,nlâŠ¸âˆ¾âŸ©)Â¨fe))âˆ¾((Â¬ğ•¨)âˆ§Ã—â‰ ft)âŠ""â€¿nl
}

IncludesUnitTest â† { âˆ¨Â´(âˆ¨Â´1â†‘"u.UnitFa"âŠ¸â·âˆ¨"u.UnitTe"âŠ¸â·âˆ¨("UnitFail"âŠ¸â·âˆ¨"UnitTest"âŠ¸â·))Â¨(Â¬Â·âˆ¨Â´"â‡"âŠ¸â·)Â¨âŠ¸/â€¢file.Linesğ•© }

main â† {
    â€¢Out title
    (c.Red "Must provide directory") ! 0â‰ â‰ â€¢args
    d â† { "."â‰¡0âŠ‘â€¢args ? â€¢wdpath ; 0âŠ‘â€¢args } # directory
    v â† 1<â‰ â€¢args                            # verbose
    { v ? (c.Red "2nd argument must be '-v' (if specified)") ! "-v"â‰¡âŠ‘1âŠâ€¢args ; âˆ }
    out â† vâŠ¸TestSingleFileÂ¨âˆ§IncludesUnitTestÂ¨âŠ¸/fs.ListRecursiveBQNFiles d
    { v ? â€¢OutÂ¨ out ; â€¢Out âˆ¾out }
    t â† â€¢FmtÂ¨âŠ‘+Ë(+Ë=âŒœâŸœdots)Â¨out # totals
    â€¢Out nlâˆ¾nlâˆ¾Ëœ", " s.Join colors{ğ•ğ•©}Â¨tâˆ¾Â¨" passed"â€¿" xfailed"â€¿" failed"
}

main
